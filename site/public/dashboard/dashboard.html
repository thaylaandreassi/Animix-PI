<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://kit.fontawesome.com/4ea0191552.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="dashboard.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterdados(1), obterDadosGrafico(1)">
    <div class="sidebar">
        <div class="logo_content">
            <div class="logo">
                <div class="logo_nome">Animix</div>
            </div>
            <i class='bx bx-menu' id="btn"></i>
        </div>
        <ul class="nav_list">
            <li>
                <a href="pre-dashboard.html">
                    <i class='bx bx-grid-alt'></i>
                    <span class="links_name">Pré-Dashboard</span>
                </a>
                <span class="tooltip">Pré-Dashboard</span>
            </li>
            <li>
                <a href="dashboard.html">
                    <i class=' bx bx-objects-horizontal-left'></i>
                    <span class="links_name">Dashboard</span>
                </a>
                <span class="tooltip">Dashboard</span>
            </li>
            <li>
                <a href="cadastro-funcionarios.html">
                    <i class='bx bx-user-plus'></i>
                    <span class="links_name">Adicionar Pessoas</span>
                </a>
                <span class="tooltip">Funcionários</span>
            </li>
            <li>
                <a href="cadastro-maquinas.html">
                    <i class='bx bx-laptop'></i>
                    <span class="links_name">Adicionar Máquinas</span>
                </a>
                <span class="tooltip">Máquinas</span>
            </li>
            <li>
                <a href="#">
                    <i class='bx bx-support'></i>
                    <span class="links_name">Suporte</span>
                </a>
                <span class="tooltip">Suporte</span>
            </li>
            <li>
                <a href="../index.html">
                    <i class='bx bx-exit' id="log_out"></i>
                </a>
            </li>
        </ul>
    </div>
    <main>
        <div class="charts-container">
            <div class="kpis">
                <div class="kpi-card">
                    <i class="fa-solid fa-temperature-arrow-up"></i>
                    <div class="text-temp">
                        <h5>Maior temperatura</h5>
                        <h1 id="maiortemp"></h1>
                    </div>
                </div>
                <div class="kpi-card">
                    <i class="fa-solid fa-floppy-disk"></i>
                    <div class="text-temp">
                        <h5>Maior uso de disco</h5>
                        <h1 id="maiordisco"></h1>
                    </div>
                </div>
                <div class="kpi-card">
                    <i class="fa-solid fa-memory"></i>
                    <div class="text-temp">
                        <h5>Maior uso de memoria</h5>
                        <h1 id="maiormemoria"></h1>
                    </div>
                </div>
                <div class="kpi-card">
                    <i class="fa-solid fa-microchip"></i>
                    <div class="text-temp">
                        <h5>Maior uso de processador</h5>
                        <h1 id="maiorprocessador"></h1>
                    </div>
                </div>
            </div>
            <div class="mid-graphs">
                <div class="graph-left">
                    <canvas id="myChart"></canvas>
                </div>
                <div class="graph-right">
                    <canvas id="myChart2"></canvas>
                </div>
            </div>
            <div class="bottom-graphs">
                <div class="card">
                    <canvas id="myChart3"></canvas>
                </div>
                <div class="card">
                    <canvas id="myChart4"></canvas>
                </div>
                <div class="card">
                    <canvas id="myChart5"></canvas>
                </div>
            </div>
        </div>
        <div class="graphs-container">
            <div class="left-section">
                <div class="info-card">
                    <h4> <i class="fa-solid fa-laptop"></i> Sistema operacional: <span id="sistema">Ubuntu</span> </h4>
                    <h4> <i class="fa-solid fa-copyright"></i> Fabricante: <span id="fabricante">GNU/Linux</span> </h4>
                    <h4> <i class="fa-solid fa-cube"></i> Arquitetura: <span id="arquitetura">64 bits</span></h4>
                    <h4> <i class="fa-solid fa-flag-checkered"></i> Inicializado: <span
                            id="inicializado">2021-03-13T16:07:18Z</span></h4>
                    <h4> <i class="fa-solid fa-hourglass-start"></i> Tempo de atividade: <span id="atividade">3 days,
                            06:55:53</span></h4>
                    <h4> <i class="fa-solid fa-shield-halved"></i> Permissões: <span id="permissoes">Executando como
                            usuário padrão</span></h4>
                </div>
                <div class="quick-access">
                    <h3>Acesse outras máquinas</h3>
                    <div class="top">
                        <div class="maquina-critica"></div>
                        <div class="maquina-critica"></div>
                        <div class="maquina-alerta"></div>
                    </div>
                    <div class="bottom">
                        <div class="maquina-alerta"></div>
                        <div class="maquina-alerta"></div>
                        <a href="pre-dashboard.html">
                            <div class="outro"><i class="fa-solid fa-ellipsis fa-5x"></i></div>
                        </a>
                    </div>
                </div>
            </div>
            <div class="right-section">
                <div class="heatmap">

                </div>
            </div>

        </div>

    </main>

</body>

</html>
<script>
    var idMaquina = 1;
    let btn = document.querySelector("#btn");
    let sidebar = document.querySelector(".sidebar");

    btn.onclick = function (params) {
        sidebar.classList.toggle("active");
    }
</script>
<script>
    const labels = [
        
    ];


    const data = {
        labels: labels,
        datasets: [{
            label: 'Memoria em tempo real',
            backgroundColor: 'rgb(255, 255, 255)',
            borderColor: 'rgb(85, 21, 66)',
            data: [],
        }]
    };
    const data2 = {
        labels: labels,
        datasets: [{
            label: 'Processador em tempo real',
            backgroundColor: 'rgb(255, 255, 255)',
            borderColor: 'rgb(85, 21, 66)',
            data: [],
        }]
    };
    const data3 = {
        labels: labels,
        datasets: [{
            label: 'Disco em tempo real',
            backgroundColor: 'rgb(255, 255, 255)',
            borderColor: 'rgb(85, 21, 66)',
            data: [],
        }]
    };
    const data4 = {
        labels: labels,
        datasets: [{
            label: 'Temperatura em tempo real',
            backgroundColor: 'rgb(255, 255, 255)',
            borderColor: 'rgb(85, 21, 66)',
            data: [],
        }]
    };
    const data5 = {
        labels: labels,
        datasets: [{
            label: 'A definir',
            data: [],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(255, 205, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(201, 203, 207, 0.2)'
            ],
            borderColor: [
                'rgb(255, 99, 132)',
                'rgb(255, 159, 64)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(54, 162, 235)',
                'rgb(153, 102, 255)',
                'rgb(201, 203, 207)'
            ],
            borderWidth: 1
        }]
    };

    const config = {
        type: 'line',
        data: data,
        options: {}
    };
    const config2 = {
        type: 'line',
        data: data2,
        options: {}
    };
    const config3 = {
        type: 'line',
        data: data3,
        options: {}
    };
    const config4 = {
        type: 'line',
        data: data4,
        options: {}
    };
    const config5 = {
        type: 'bar',
        data: data5,
        options: {}
    };


</script>
<script>
    const myChart = new Chart(
        document.getElementById('myChart'),
        config
    );
    const myChart2 = new Chart(
        document.getElementById('myChart2'),
        config2
    );
    const myChart3 = new Chart(
        document.getElementById('myChart3'),
        config3
    );
    const myChart4 = new Chart(
        document.getElementById('myChart4'),
        config4
    );
    const myChart5 = new Chart(
        document.getElementById('myChart5'),
        config5
    );

    setInterval(() => {
        obterdados(1), atualizarGrafico(idMaquina, data, data2, data3, data4, data5, myChart, myChart2, myChart3, myChart4, myChart5)
    }, 2000);

    function obterdados(idMaquina) {
        fetch(`/cards/tempo-real/${idMaquina}`)
            .then(resposta => {
                var maiorTemp = document.getElementById('maiortemp');
                var maiorDisco = document.getElementById('maiordisco');
                var maiorProcessador = document.getElementById('maiorprocessador');
                var maiorMemoria = document.getElementById('maiormemoria');
                if (resposta.ok) {
                    resposta.json().then(resposta => {
                        maiorProcessador.innerHTML = resposta[0].processador + "%";
                        maiorDisco.innerHTML = resposta[0].disco + "%";
                        maiorMemoria.innerHTML = resposta[0].memoria + "%";
                        maiorTemp.innerHTML = resposta[0].temperatura + "°";

                    });
                } else {

                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados do aquario p/ gráfico: ${error.message}`);
            });
    }

    function obterDadosGrafico(idMaquina) {

        // if (proximaAtualizacao != undefined) {
        //     clearTimeout(proximaAtualizacao);
        // }

        fetch(`/graficos/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idMaquina);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idMaquina) {
        console.log('iniciando plotagem do gráfico...');

        // // Criando estrutura para plotar gráfico - labels
        // let labels = [];

        // // Criando estrutura para plotar gráfico - dados
        // let dados = {
        //     labels: labels,
        //     datasets: [{
        //         label: 'Umidade',
        //         data: [],
        //         fill: false,
        //         borderColor: 'rgb(75, 192, 192)',
        //         tension: 0.1
        //     },
        //     {
        //         label: 'Temperatura',
        //         data: [],
        //         fill: false,
        //         borderColor: 'rgb(199, 52, 52)',
        //         tension: 0.1
        //     }]
        // };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            data.datasets[0].data.push(registro.memoria);
            data2.datasets[0].data.push(registro.processador);
            data3.datasets[0].data.push(registro.disco);
            data4.datasets[0].data.push(registro.temperatura);
            // data5.datasets[4].data.push(registro.umidade);
        }

        // console.log('----------------------------------------------')
        // console.log('O gráfico será plotado com os respectivos valores:')
        // console.log('Labels:')
        // console.log(labels)
        // console.log('Dados:')
        // console.log(dados.datasets)
        // console.log('----------------------------------------------')

        // // Criando estrutura para plotar gráfico - config
        // const config = {
        //     type: 'line',
        //     data: dados,
        // };

        // // Adicionando gráfico criado em div na tela
        // let myChart = new Chart(
        //     document.getElementById('myChart'),
        //     config
        // );

        setTimeout(() => atualizarGrafico(idMaquina, data, data2, data3, data4, data5, myChart, myChart2, myChart3, myChart4, myChart5), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idMaquina, data, data2, data3, data4, data5, myChart, myChart2, myChart3, myChart4, myChart5) {

        fetch(`/graficos/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    // console.log(`Dados atuais do gráfico:`);
                    // console.log(dados);

                    // document.getElementById("avisoCaptura").innerHTML = ""

                    // if (novoRegistro[0].momento_grafico == data.labels[data.labels.length - 1]) {
                    //     // console.log("---------------------------------------------------------------")
                    //     // console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                    //     // document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                    //     // console.log("Horário do novo dado capturado:")
                    //     // console.log(novoRegistro[0].momento_grafico)
                    //     // console.log("Horário do último dado capturado:")
                    //     // console.log(dados.labels[dados.labels.length - 1])
                    //     // console.log("---------------------------------------------------------------")
                    // } else {
                        // tirando e colocando valores no gráfico
                        data.labels.shift(); // apagar o primeiro
                        data.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        data.datasets[0].data.shift();  // apagar o primeiro de umidade
                        data.datasets[0].data.push(novoRegistro[0].memoria); // incluir uma nova medida de umidade

                        myChart.update();

                        data2.labels.shift(); // apagar o primeiro
                        data2.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        data2.datasets[0].data.shift();  // apagar o primeiro de umidade
                        data2.datasets[0].data.push(novoRegistro[0].processador); // incluir uma nova medida de umidade

                        myChart2.update();

                        data3.labels.shift(); // apagar o primeiro
                        data3.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        data3.datasets[0].data.shift();  // apagar o primeiro de umidade
                        data3.datasets[0].data.push(novoRegistro[0].disco); // incluir uma nova medida de umidade

                        myChart3.update();
                        
                        data4.labels.shift(); // apagar o primeiro
                        data4.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        data4.datasets[0].data.shift();  // apagar o primeiro de umidade
                        data4.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de umidade

                        myChart4.update();

                        // data5.labels.shift(); // apagar o primeiro
                        // data5.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        // data5.datasets[0].data.shift();  // apagar o primeiro de umidade
                        // data5.datasets[0].data.push(novoRegistro[0].processador); // incluir uma nova medida de umidade

                        // myChart5.update();
                    // }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, data, data2, data3, data4, data5, myChart, myChart2, myChart3, myChart4, myChart5), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idMaquina, data, data2, data3, data4, data5, myChart, myChart2, myChart3, myChart4, myChart5), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


</script>